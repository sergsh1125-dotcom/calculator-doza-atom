<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>calculator-doza</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    h1 { font-size: 20px; }
    .container { max-width: 900px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
    .grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap: 10px; }
    label { font-size: 14px; display: block; margin-bottom: 10px; }
    input, select { width: 100%; padding: 6px; margin-top: 3px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #eee; }
    button { padding: 8px 12px; margin-top: 10px; cursor: pointer; border-radius: 5px; border: none; }
    .btn-blue { background: #007bff; color: white; }
    .btn-gray { background: #ccc; }
  </style>
</head>
<body>
<div class="container">
  <h1>calculator-doza — калькулятор дозы при ядерном взрыве</h1>
  <div class="grid">
    <label>Pt — мощность дозы в момент измерения (мЗв/ч)
      <input type="number" id="Pt" value="0.5" step="any">
    </label>
    <label>t — время измерения Pt (ч)
      <input type="number" id="tMeasure" value="2" step="any">
    </label>
    <label>Ta — начало облучения (ч)
      <input type="number" id="Ta" value="3" step="any">
    </label>
    <label>Tb — конец облучения (ч)
      <input type="number" id="Tb" value="10" step="any">
    </label>
    <label>Kz — коэффициент защиты
      <select id="Kz">
        <option>1</option><option>2</option><option>4</option><option>10</option><option>50</option><option>100</option><option>500</option>
      </select>
    </label>
  </div>

  <h3>Результаты</h3>
  <p>P1 (через 1 час): <span id="P1">0</span> мЗв/ч</p>
  <p>D (доза Ta→Tb): <span id="dose">0</span> мЗв</p>

  <h3>График спада мощности дозы</h3>
  <canvas id="chart" height="200"></canvas>

  <h3>Таблица доз</h3>
  <table id="doseTable">
    <thead>
      <tr><th>Начало (ч)</th><th>Конец (ч)</th><th>Часы</th><th>Доза (мЗв)</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <button class="btn-blue" onclick="downloadCSV()">Сохранить в Excel (CSV)</button>
  <button class="btn-gray" onclick="copyResult()">Копировать результат</button>

  <p style="font-size:12px;color:gray;">Модель использует степенной закон (-1.2). Для реальных решений ориентируйтесь на официальные источники.</p>
</div>

<script>
function calc() {
  const Pt = parseFloat(document.getElementById('Pt').value);
  const t = parseFloat(document.getElementById('tMeasure').value);
  const Ta = parseFloat(document.getElementById('Ta').value);
  const Tb = parseFloat(document.getElementById('Tb').value);
  const Kz = parseFloat(document.getElementById('Kz').value);

  if (isNaN(Pt) || isNaN(t) || t<=0) return;
  const P1 = Pt * Math.pow(t, 1.2);
  let dose = 0;
  if (Ta>0 && Tb>Ta) {
    dose = (5 * P1 * (Math.pow(Ta,-1.2) - Math.pow(Tb,-1.2)))/Kz;
    if (dose<0) dose=0;
  }

  document.getElementById('P1').innerText = P1.toFixed(6);
  document.getElementById('dose').innerText = dose.toFixed(6);

  const data=[];
  for (let i=1;i<=96;i++){
    data.push({x:i, y: P1*Math.pow(i,-1.2)});
  }
  chart.data.datasets[0].data=data;
  chart.update();

  const tbody=document.querySelector('#doseTable tbody');
  tbody.innerHTML='';
  let total=0;
  let cursor=Math.floor(Ta);
  let firstEnd=Math.min(Tb, Math.ceil(Ta));
  if (firstEnd>Ta){
    let Dseg=(5*P1*(Math.pow(Ta,-1.2)-Math.pow(firstEnd,-1.2)))/Kz;
    tbody.innerHTML+=row(Ta,firstEnd,firstEnd-Ta,Dseg);
    total+=Dseg;
  }
  cursor=Math.ceil(Ta);
  while(cursor+1<=Tb){
    let Dseg=(5*P1*(Math.pow(cursor,-1.2)-Math.pow(cursor+1,-1.2)))/Kz;
    tbody.innerHTML+=row(cursor,cursor+1,1,Dseg);
    total+=Dseg;
    cursor++;
  }
  if (cursor<Tb){
    let Dseg=(5*P1*(Math.pow(cursor,-1.2)-Math.pow(Tb,-1.2)))/Kz;
    tbody.innerHTML+=row(cursor,Tb,Tb-cursor,Dseg);
    total+=Dseg;
  }
  tbody.innerHTML+=`<tr style="font-weight:bold"><td colspan=3>Итого</td><td>${total.toFixed(6)}</td></tr>`;

  return {P1,dose};
}

function row(s,e,h,d){
  return `<tr><td>${s}</td><td>${e}</td><td>${h.toFixed(3)}</td><td>${d.toFixed(6)}</td></tr>`;
}

function downloadCSV(){
  const rows=[];
  document.querySelectorAll('#doseTable tr').forEach(tr=>{
    const cells=[...tr.querySelectorAll('td,th')].map(td=>td.innerText);
    rows.push(cells.join(","));
  });
  const csv=rows.join("
");
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download='calculator-doza.csv';
  a.click();
  URL.revokeObjectURL(url);
}

function copyResult(){
  const P1=document.getElementById('P1').innerText;
  const D=document.getElementById('dose').innerText;
  navigator.clipboard.writeText(`P1=${P1} mSv/h
D=${D} mSv`);
}

const ctx=document.getElementById('chart').getContext('2d');
const chart=new Chart(ctx,{
  type:'line',
  data:{datasets:[{label:'мЗв/ч', data:[], borderColor:'blue', fill:false}]},
  options:{scales:{x:{title:{display:true,text:'Часы'}},y:{title:{display:true,text:'мЗв/ч'}}}}
});

['Pt','tMeasure','Ta','Tb','Kz'].forEach(id=>{
  document.getElementById(id).addEventListener('input',calc);
});

calc();
</script>
</body>
</html>
